# Task 1

## Kubectl secrets
1. Create secret
```
 kubectl apply -f secret.yml 
```

```
secret/devops-secret created
```
2. Check it is created correctly
```
 kubectl get secrets devops-secret
```
```
NAME            TYPE     DATA   AGE
devops-secret   Opaque   1      96s
```
3. Manifest info
```
kubectl get secrets devops-secret -o yaml
```
```
apiVersion: v1
data:
  password: YWJvYmExMjM0
kind: Secret
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","data":{"password":"YWJvYmExMjM0"},"kind":"Secret","metadata":{"annotations":{},"name":"devops-secret","namespace":"default"},"type":"Opaque"}
  creationTimestamp: "2023-11-13T12:33:27Z"
  name: devops-secret
  namespace: default
  resourceVersion: "64840"
  uid: 487c31ee-bab7-4ccd-b14f-e2ea80b4d73b
type: Opaque
```

4. decode password from secret
```
kubectl get secret devops-secret -o jsonpath='{.data.password}' | base64 --decode
```

```
aboba1234
```

## Helm secrets
1. install helm secrets plugin
```
helm plugin install https://github.com/zendesk/helm-secrets
```
```      
Selecting previously unselected package sops.
(Reading database ... 373094 files and directories currently installed.)
Preparing to unpack /tmp/sops ...
Unpacking sops (3.0.4) ...
Setting up sops (3.0.4) ...
Deprecation Info
  Please note, this project is no longer being maintained.
  Link to active helm-secret plugin could be found in helm documentation: https://helm.sh/docs/community/related/#helm-plugins
Installed plugin: secrets
```
2. Install with secrets
```
helm secrets install python ./python-app/ -f secret.yml --values ./python-app/values.python.yml 
```
```
NAME: python
LAST DEPLOYED: Mon Nov 13 17:15:58 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  http://python.timer.app/

```
3. Check installation 
```
kubectl get svc,deployments,secrets
```
```
NAME                        TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
service/kubernetes          ClusterIP      10.96.0.1       <none>        443/TCP          5d22h
service/python-python-app   LoadBalancer   10.97.128.245   <pending>     5000:32201/TCP   61s

NAME                                READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/python-python-app   3/3     3            3           61s

NAME                                  TYPE                 DATA   AGE
secret/devops-secret                  Opaque               1      157m
secret/sh.helm.release.v1.python.v1   helm.sh/release.v1   1      83s
```

```
kubectl get pods -A
```
```
NAMESPACE              NAME                                         READY   STATUS      RESTARTS        AGE
default                python-python-app-6f55655c9b-nq2gt           1/1     Running     0               108s
default                python-python-app-6f55655c9b-wcgsg           1/1     Running     0               108s
default                python-python-app-6f55655c9b-ztf8w           1/1     Running     0               108s
ingress-nginx          ingress-nginx-admission-create-j9872         0/1     Completed   0               12d
ingress-nginx          ingress-nginx-admission-patch-7qdsn          0/1     Completed   1               12d
ingress-nginx          ingress-nginx-controller-7799c6795f-z7jws    1/1     Running     1 (159m ago)    12d
kube-system            coredns-5d78c9869d-6k9r2                     1/1     Running     4 (4d18h ago)   13d
kube-system            etcd-minikube                                1/1     Running     4 (4d18h ago)   13d
kube-system            kube-apiserver-minikube                      1/1     Running     4 (159m ago)    13d
kube-system            kube-controller-manager-minikube             1/1     Running     4 (4d18h ago)   13d
kube-system            kube-proxy-54f42                             1/1     Running     4 (4d18h ago)   13d
kube-system            kube-scheduler-minikube                      1/1     Running     4 (4d18h ago)   13d
kube-system            storage-provisioner                          1/1     Running     6 (158m ago)    13d
kubernetes-dashboard   dashboard-metrics-scraper-5dd9cbfd69-zq2hv   1/1     Running     1 (4d18h ago)   5d23h
kubernetes-dashboard   kubernetes-dashboard-5c5cfc8747-cn255        1/1     Running     2 (158m ago)    5d23h
```
```
kubectl get po
```
```
NAME                                 READY   STATUS    RESTARTS   AGE
python-python-app-6f55655c9b-nq2gt   1/1     Running   0          8m56s
python-python-app-6f55655c9b-wcgsg   1/1     Running   0          8m56s
python-python-app-6f55655c9b-ztf8w   1/1     Running   0          8m56s
```

```
kubectl exec python-python-app-6f55655c9b-nq2gt -- env | grep MY_PASSWORD
```
```
MY_PASSWORD=aboba1234
```

# Task 2
1. Install vault via ```helm install vault hashicorp/vault --set "server.dev.enabled=true"```
2. After installation, we can find vault related pods
```
kubectl get pods
```

```
NAME                                    READY   STATUS    RESTARTS   AGE
vault-0                                 1/1     Running   0          81m
vault-agent-injector-5cd8b87c6c-hcw9q   1/1     Running   0          81m
```
3. execute ```kubectl exec -it vault-0 -- /bin/sh``` to enter vault's bash
4. In bash:
```
vault secrets enable -path=internal kv-v2
```

```
Success! Enabled the kv-v2 secrets engine at: internal/
```

```
vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
```

```
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-13T17:01:12.682110192Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
```

5. verify that secret was defined
```
vault kv get internal/database/config
```
same as in previous
```
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-13T17:01:12.682110192Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
```
6. Start Auth setup
```
vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
```
7. Configure kubernetess auth method
```
vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
```
```
Success! Data written to: auth/kubernetes/config
```

8. create upload policy
```
/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF

Success! Uploaded policy: internal-app
```
9. create auth role
```
/ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=python-python-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
```

10. check service accounts
```
kubectl get sa -n default
NAME                   SECRETS   AGE
default                0         13d
python-python-app      0         64s
vault                  0         129m
vault-agent-injector   0         129m
```
11. extract container pod name
```
kubectl get pods -A
```
```
NAMESPACE              NAME                                         READY   STATUS      RESTARTS        AGE
default                python-python-app-6f55655c9b-fkl28           2/2     Running     0               104s
default                python-python-app-6f55655c9b-njqbz           2/2     Running     0               104s
default                python-python-app-6f55655c9b-tk65d           2/2     Running     0               104s
...
```
12. Exec application to enter inside container
```
kubectl exec  python-python-app-6f55655c9b-fkl28  -it /bin/sh
```

```
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
Defaulted container "python-app" out of: python-app, vault-agent, vault-agent-init (init)
```

13. Check secret for existence
```
/ $ cat /vault/secrets/database-config.txt 
```
```
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2023-11-13T17:01:12.682110192Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```

```
df -h
```
```
Filesystem                Size      Used Available Use% Mounted on
overlay                  49.8G     45.9G      1.3G  97% /
tmpfs                    64.0M         0     64.0M   0% /dev
tmpfs                    11.7G         0     11.7G   0% /sys/fs/cgroup
/dev/nvme0n1p5           49.8G     45.9G      1.3G  97% /dev/termination-log
tmpfs                   640.0M      4.0K    640.0M   0% /vault/secrets
/dev/nvme0n1p5           49.8G     45.9G      1.3G  97% /etc/resolv.conf
/dev/nvme0n1p5           49.8G     45.9G      1.3G  97% /etc/hostname
/dev/nvme0n1p5           49.8G     45.9G      1.3G  97% /etc/hosts
shm                      64.0M         0     64.0M   0% /dev/shm
tmpfs                   640.0M     12.0K    640.0M   0% /run/secrets/kubernetes.io/serviceaccount
tmpfs                    11.7G         0     11.7G   0% /proc/asound
tmpfs                    11.7G         0     11.7G   0% /proc/acpi
tmpfs                    64.0M         0     64.0M   0% /proc/kcore
tmpfs                    64.0M         0     64.0M   0% /proc/keys
tmpfs                    64.0M         0     64.0M   0% /proc/timer_list
tmpfs                    64.0M         0     64.0M   0% /proc/sched_debug
tmpfs                    11.7G         0     11.7G   0% /proc/scsi
tmpfs                    11.7G         0     11.7G   0% /sys/firmware
```

# Bonus

1. Limits:

Add this to values
```
resources:
  # We usually recommend not to specify default resources and to leave this as a conscious
  # choice for the user. This also increases chances charts run on environments with little
  # resources, such as Minikube. If you do want to specify resources, uncomment the following
  # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
   limits:
     cpu: 300m
     memory: 512Mi
   requests:
     cpu: 100m
     memory: 256Mi
```
Then install app and check
```
kubectl get po
```
```
NAME                                    READY   STATUS    RESTARTS      AGE
python-python-app-6f55655c9b-cx6xl      2/2     Running   0             2m3s
python-python-app-6f55655c9b-pxbfq      2/2     Running   0             2m3s
python-python-app-6f55655c9b-qv59c      2/2     Running   0             2m3s
vault-0                                 1/1     Running   2 (45m ago)   4h10m
vault-agent-injector-5cd8b87c6c-hcw9q   1/1     Running   2 (45m ago)   4h10m

```
```
kubectl describe pod python-python-app-6f55655c9b-cx6xl 
```
```
Name:             python-python-app-6f55655c9b-cx6xl
Namespace:        default
Priority:         0
Service Account:  python-python-app
Node:             minikube/192.168.49.2
Start Time:       Mon, 13 Nov 2023 22:44:40 +0300
Labels:           absolutely_not_default=super_label
                  app.kubernetes.io/instance=python
                  app.kubernetes.io/managed-by=Helm
                  app.kubernetes.io/name=python-app
                  app.kubernetes.io/version=1.16.0
                  helm.sh/chart=python-app-0.1.0
                  pod-template-hash=6f55655c9b
Annotations:      vault.hashicorp.com/agent-inject: true
                  vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
                  vault.hashicorp.com/agent-inject-status: injected
                  vault.hashicorp.com/role: internal-app
Status:           Running
IP:               10.244.0.232
IPs:
  IP:           10.244.0.232
Controlled By:  ReplicaSet/python-python-app-6f55655c9b
Init Containers:
  vault-agent-init:
    Container ID:  docker://c70267065a3478764654d5a934b881e4d9ab12b66cda4971acfc9aba6fb96681
    Image:         hashicorp/vault:1.15.1
    Image ID:      docker-pullable://hashicorp/vault@sha256:6a96634beeda3f989a4d9d85a951fe835fe8504e4dae5b46610f7c4104e8388b
    Port:          <none>
    Host Port:     <none>
    Command:
      /bin/sh
      -ec
    Args:
      echo ${VAULT_CONFIG?} | base64 -d > /home/vault/config.json && vault agent -config=/home/vault/config.json
    State:          Terminated
      Reason:       Completed
      Exit Code:    0
      Started:      Mon, 13 Nov 2023 22:44:41 +0300
      Finished:     Mon, 13 Nov 2023 22:44:42 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     500m
      memory:  128Mi
    Requests:
      cpu:     250m
      memory:  64Mi
    Environment:
      NAMESPACE:         default (v1:metadata.namespace)
      HOST_IP:            (v1:status.hostIP)
      POD_IP:             (v1:status.podIP)
      VAULT_LOG_LEVEL:   info
      VAULT_LOG_FORMAT:  standard
      VAULT_CONFIG:      eyJhdXRvX2F1dGgiOnsibWV0aG9kIjp7InR5cGUiOiJrdWJlcm5ldGVzIiwibW91bnRfcGF0aCI6ImF1dGgva3ViZXJuZXRlcyIsImNvbmZpZyI6eyJyb2xlIjoiaW50ZXJuYWwtYXBwIiwidG9rZW5fcGF0aCI6Ii92YXIvcnVuL3NlY3JldHMva3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC90b2tlbiJ9fSwic2luayI6W3sidHlwZSI6ImZpbGUiLCJjb25maWciOnsicGF0aCI6Ii9ob21lL3ZhdWx0Ly52YXVsdC10b2tlbiJ9fV19LCJleGl0X2FmdGVyX2F1dGgiOnRydWUsInBpZF9maWxlIjoiL2hvbWUvdmF1bHQvLnBpZCIsInZhdWx0Ijp7ImFkZHJlc3MiOiJodHRwOi8vdmF1bHQuZGVmYXVsdC5zdmM6ODIwMCJ9LCJ0ZW1wbGF0ZSI6W3siZGVzdGluYXRpb24iOiIvdmF1bHQvc2VjcmV0cy9kYXRhYmFzZS1jb25maWcudHh0IiwiY29udGVudHMiOiJ7eyB3aXRoIHNlY3JldCBcImludGVybmFsL2RhdGEvZGF0YWJhc2UvY29uZmlnXCIgfX17eyByYW5nZSAkaywgJHYgOj0gLkRhdGEgfX17eyAkayB9fToge3sgJHYgfX1cbnt7IGVuZCB9fXt7IGVuZCB9fSIsImxlZnRfZGVsaW1pdGVyIjoie3siLCJyaWdodF9kZWxpbWl0ZXIiOiJ9fSJ9XSwidGVtcGxhdGVfY29uZmlnIjp7ImV4aXRfb25fcmV0cnlfZmFpbHVyZSI6dHJ1ZX19
    Mounts:
      /home/vault from home-init (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-bmvh2 (ro)
      /vault/secrets from vault-secrets (rw)
Containers:
  python-app:
    Container ID:   docker://212747f96a4414889dec813be98551f72882e3a70124ee86d1a3cc26dbea05e9
    Image:          dashvayet/python_app:latest
    Image ID:       docker-pullable://dashvayet/python_app@sha256:a3bc9fed57bc86603fb11f16d5cf56da0763d3fcdaa5d9c73a887269d0ddcf92
    Port:           5000/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Mon, 13 Nov 2023 22:44:42 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     300m
      memory:  512Mi
    Requests:
      cpu:      100m
      memory:   256Mi
    Liveness:   http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment:
      MY_PASSWORD:  <set to the key 'password' in secret 'devops-secret'>  Optional: false
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-bmvh2 (ro)
      /vault/secrets from vault-secrets (rw)
  vault-agent:
    Container ID:  docker://fe25a3736b177619ecc43a585e4811fd1641ece1dbf4a142a5d0da97d0b794ee
    Image:         hashicorp/vault:1.15.1
    Image ID:      docker-pullable://hashicorp/vault@sha256:6a96634beeda3f989a4d9d85a951fe835fe8504e4dae5b46610f7c4104e8388b
    Port:          <none>
    Host Port:     <none>
    Command:
      /bin/sh
      -ec
    Args:
      echo ${VAULT_CONFIG?} | base64 -d > /home/vault/config.json && vault agent -config=/home/vault/config.json
    State:          Running
      Started:      Mon, 13 Nov 2023 22:44:43 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     500m
      memory:  128Mi
    Requests:
      cpu:     250m
      memory:  64Mi
    Environment:
      NAMESPACE:         default (v1:metadata.namespace)
      HOST_IP:            (v1:status.hostIP)
      POD_IP:             (v1:status.podIP)
      VAULT_LOG_LEVEL:   info
      VAULT_LOG_FORMAT:  standard
      VAULT_CONFIG:      eyJhdXRvX2F1dGgiOnsibWV0aG9kIjp7InR5cGUiOiJrdWJlcm5ldGVzIiwibW91bnRfcGF0aCI6ImF1dGgva3ViZXJuZXRlcyIsImNvbmZpZyI6eyJyb2xlIjoiaW50ZXJuYWwtYXBwIiwidG9rZW5fcGF0aCI6Ii92YXIvcnVuL3NlY3JldHMva3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC90b2tlbiJ9fSwic2luayI6W3sidHlwZSI6ImZpbGUiLCJjb25maWciOnsicGF0aCI6Ii9ob21lL3ZhdWx0Ly52YXVsdC10b2tlbiJ9fV19LCJleGl0X2FmdGVyX2F1dGgiOmZhbHNlLCJwaWRfZmlsZSI6Ii9ob21lL3ZhdWx0Ly5waWQiLCJ2YXVsdCI6eyJhZGRyZXNzIjoiaHR0cDovL3ZhdWx0LmRlZmF1bHQuc3ZjOjgyMDAifSwidGVtcGxhdGUiOlt7ImRlc3RpbmF0aW9uIjoiL3ZhdWx0L3NlY3JldHMvZGF0YWJhc2UtY29uZmlnLnR4dCIsImNvbnRlbnRzIjoie3sgd2l0aCBzZWNyZXQgXCJpbnRlcm5hbC9kYXRhL2RhdGFiYXNlL2NvbmZpZ1wiIH19e3sgcmFuZ2UgJGssICR2IDo9IC5EYXRhIH19e3sgJGsgfX06IHt7ICR2IH19XG57eyBlbmQgfX17eyBlbmQgfX0iLCJsZWZ0X2RlbGltaXRlciI6Int7IiwicmlnaHRfZGVsaW1pdGVyIjoifX0ifV0sInRlbXBsYXRlX2NvbmZpZyI6eyJleGl0X29uX3JldHJ5X2ZhaWx1cmUiOnRydWV9fQ==
    Mounts:
      /home/vault from home-sidecar (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-bmvh2 (ro)
      /vault/secrets from vault-secrets (rw)
Conditions:
  Type              Status
  Initialized       True 
  Ready             True 
  ContainersReady   True 
  PodScheduled      True 
Volumes:
  kube-api-access-bmvh2:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
  home-init:
    Type:       EmptyDir (a temporary directory that shares a pod's lifetime)
    Medium:     Memory
    SizeLimit:  <unset>
  home-sidecar:
    Type:       EmptyDir (a temporary directory that shares a pod's lifetime)
    Medium:     Memory
    SizeLimit:  <unset>
  vault-secrets:
    Type:        EmptyDir (a temporary directory that shares a pod's lifetime)
    Medium:      Memory
    SizeLimit:   <unset>
QoS Class:       Burstable
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                 node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason     Age    From               Message
  ----     ------     ----   ----               -------
  Normal   Scheduled  2m13s  default-scheduler  Successfully assigned default/python-python-app-6f55655c9b-cx6xl to minikube
  Normal   Pulled     2m12s  kubelet            Container image "hashicorp/vault:1.15.1" already present on machine
  Normal   Created    2m12s  kubelet            Created container vault-agent-init
  Normal   Started    2m12s  kubelet            Started container vault-agent-init
  Normal   Pulled     2m11s  kubelet            Container image "dashvayet/python_app:latest" already present on machine
  Normal   Created    2m11s  kubelet            Created container python-app
  Normal   Started    2m11s  kubelet            Started container python-app
  Normal   Pulled     2m11s  kubelet            Container image "hashicorp/vault:1.15.1" already present on machine
  Normal   Created    2m11s  kubelet            Created container vault-agent
  Normal   Started    2m10s  kubelet            Started container vault-agent

```
As my applications shares same chart template, we can be sure that results are same for both Charts

According to description of pod we can state that limits was applied successfully to applications
2. Envs

I created a env that will fastly include environment variables to deployment ```mySecrets```
test:
```
kubectl get po
NAME                                    READY   STATUS    RESTARTS      AGE
python-python-app-6f55655c9b-cfwbb      2/2     Running   0             77s
python-python-app-6f55655c9b-pdcvz      2/2     Running   0             77s
python-python-app-6f55655c9b-sjvz8      2/2     Running   0             77s
vault-0                                 1/1     Running   2 (39m ago)   4h4m
vault-agent-injector-5cd8b87c6c-hcw9q   1/1     Running   2 (39m ago)   4h4m
ruslan@Elestrias:~/devops/core-course-labs/k8s$ kubectl exec python-python-app-6f55655c9b-cfwbb -- env | grep MY_PASSWORD
Defaulted container "python-app" out of: python-app, vault-agent, vault-agent-init (init)
MY_PASSWORD=aboba1234
```

As I have stated above - same chart for both applications ensures that envs are working for BOTH applications
as code is the same